<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebGIS Monitoring Sungai & Kayu Manis</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin:0; padding:0; font-family:Arial; }
    #map { height:100vh; width:100%; }
    .toolbar { 
      position:absolute; top:10px; right:10px; 
      z-index:1000; background:white; padding:5px; 
      border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.2);
    }
    .legend { 
      position:absolute; bottom:10px; left:10px; 
      z-index:1000; background:white; padding:10px; 
      border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.2);
    }
    button {
      padding:8px 12px;
      background:#3498db;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    button:hover {
      background:#2980b9;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="toolbar">
    <button id="drawPolygon"><i class="fas fa-draw-polygon"></i> Gambar</button>
    <button id="exportImage"><i class="fas fa-camera"></i> Export</button>
  </div>
  
  <div class="legend">
    <h4>Legenda:</h4>
    <p><i style="background:#3498db; width:15px; height:15px; display:inline-block;"></i> Sungai</p>
    <p><i style="background:#8B4513; width:15px; height:15px; display:inline-block;"></i> Kebun Kayu Manis</p>
  </div>

  <!-- Load JavaScript Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script>
    // Inisialisasi peta dengan base map Esri Satellite
    const map = L.map('map').setView([-2.06668, 101.40592], 13);
    
    // Tambahkan base map Esri Satellite dengan layer label
    const esriSatellite = L.esri.basemapLayer('Imagery');
    const esriLabels = L.esri.basemapLayer('ImageryLabels');
    
    // Tambahkan ke peta
    esriSatellite.addTo(map);
    esriLabels.addTo(map);
    
    // Alternatif base map
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    });
    
    // Layer control
    const baseLayers = {
      "Esri Satellite": esriSatellite,
      "OpenStreetMap": osm
    };
    
    const overlayLayers = {};
    L.control.layers(baseLayers, overlayLayers).addTo(map);

    // Data sungai contoh
    const sungai = L.polyline([
      [-2.06668, 101.40592],
      [-2.07000, 101.41000],
      [-2.07500, 101.41500]
    ], {color: '#3498db', weight: 4}).addTo(map)
    .bindPopup("Sungai Batanghari");
    
    overlayLayers["Sungai"] = sungai;

    // Load data GeoJSON kebun kayu manis
    fetch('https://faridhalfero.github.io/webgis-sungai-kayumanis/data/cinnamon.geojson')
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        const cinnamonLayer = L.geoJSON(data, {
          style: { 
            fillColor: '#8B4513', 
            weight: 2, 
            color: '#654321', 
            fillOpacity: 0.5 
          },
          onEachFeature: function(feature, layer) {
            const content = `<b>${feature.properties.name || 'Kebun Kayu Manis'}</b>`;
            if (feature.properties.area) {
              content += `<br>Luas: ${feature.properties.area} ha`;
            }
            layer.bindPopup(content);
          }
        }).addTo(map);
        
        overlayLayers["Kebun Kayu Manis"] = cinnamonLayer;
      })
      .catch(error => {
        console.error('Error loading GeoJSON:', error);
        alert('Gagal memuat data kebun kayu manis');
      });

    // Fitur draw polygon
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    overlayLayers["Polygon Buatan"] = drawnItems;
    
    const drawControl = new L.Control.Draw({
      draw: { 
        polygon: {
          shapeOptions: {
            color: '#f39c12',
            fillColor: '#f39c12',
            fillOpacity: 0.3
          },
          showArea: true
        }, 
        marker: false, 
        circle: false, 
        polyline: false, 
        rectangle: false 
      },
      edit: { 
        featureGroup: drawnItems 
      }
    });
    map.addControl(drawControl);

    map.on('draw:created', function(e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      
      if (e.layerType === 'polygon') {
        const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        layer.bindPopup(`Area: ${(area/10000).toFixed(2)} hektar`);
      }
    });

    document.getElementById('drawPolygon').addEventListener('click', function() {
      new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
    });

    document.getElementById('exportImage').addEventListener('click', function() {
      // Simple export (bisa dikembangkan dengan html2canvas)
      alert("Untuk export gambar, gunakan screenshot browser (Ctrl+Shift+S)");
    });
  </script>
</body>
</html>
